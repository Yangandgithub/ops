{% extends 'index.html' %}
{% block page-content %}
<style>
    .apps_list .panel-body{
        padding-bottom: 0;
    }
    .apps_list  .form-group{
        margin:0 0 15px 0;
    }
    /*.apps_list  .btn-group.bootstrap-select{
        width: 200px !important;
    }*/
    @media (max-width: 768px) {
        /*.apps_list .btn-group.bootstrap-select{
            width:100% !important;
        }*/

    }
    @media (max-width: 1200px)and (min-width:992px){
        /* .apps_list .queryLabel{
            width:80%;
        }*/
    }
   @media (max-width:992px)and (min-width:768px){
        /* .apps_list .queryLabel{
            width:80%;
        }*/
    }
</style>
    <div id="page-wrapper" class="apps_list">
        <div class="row">
            <div class="col-lg-12">
                <h1 class="page-header"><i class="fa  fa-align-justify "></i>&nbsp;<span>任务列表</span> </h1>
            </div>
        </div>
{#        <div class="row">#}
{#            <div class="col-lg-12">#}
{#                <div class="panel panel-default">#}
{#                    <!-- /.panel-heading -->#}
{#                    <div class="panel-body">#}
{#                        <form class="form-inline row">#}
{#                            <div class="form-group col-lg-4 col-md-4 col-sm-6">#}
{#                                <label class="control-label">任务类型</label>#}
{#                                <select class="selectpicker" data-live-search="true"#}
{#                                        data-live-search-placeholder="请输入检索内容" data-none-selected-text="请选择平台"#}
{#                                        name="playbook_type" id="playbook_type">#}
{#                                    <option name="playbook_type" value="" selected>全部类型</option>#}
{#                                    <option name="playbook_type" value="1">资产信息</option>#}
{#                                    <option name="playbook_type" value="2">基线加固</option>#}
{#                                    <option name="playbook_type" value="3">日志审计</option>#}
{#                                    <option name="playbook_type" value="4">漏洞整改与隐患排查</option>#}
{#                                    <option name="playbook_type" value="5">密码/端口检测</option>#}
{#                                    <option name="playbook_type" value="6">安全访问控制</option>#}
{#                                </select>#}
{#                            </div>#}
{#                            <div class="form-group col-lg-4 col-md-4 col-sm-6">#}
{#                                <label class="control-label ">任务名称</label>#}
{#                                <input class="form-control" id="task_name" name="task_name" type="text">#}
{#                            </div>#}
{#                            <div class="form-group col-lg-4 col-md-4 col-sm-12" style="text-align: right">#}
{#                                <label class="control-label hidden-label queryLabel"></label>#}
{#                                <input type="button" id="query" class="btn btn-primary" value="查询">#}
{#                            </div>#}
{#                        </form>#}
{#                    </div>#}
{#                </div>#}
{#            </div>#}
{#        </div>#}
        <div class="row">
            <div class="col-lg-12">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <i class="fa fa-database"></i>&nbsp;任务列表明细
                    </div>
                    <!-- /.panel-heading -->
                    <div class="panel-body">
                        <div style="float: right;margin-bottom: 10px;">
                            <form class="form-inline">
                                <label class="control-label">任务类型</label>
                                <select class="selectpicker auto-select select-sm" data-live-search="true"
                                        data-live-search-placeholder="请输入检索内容" data-none-selected-text="请选择平台"
                                        name="playbook_type" id="playbook_type">
                                    <option name="playbook_type" value="" selected>全部类型</option>
                                    <option name="playbook_type" value="1">资产信息</option>
                                    <option name="playbook_type" value="2">基线加固</option>
                                    <option name="playbook_type" value="3">日志审计</option>
                                    <option name="playbook_type" value="4">漏洞整改与隐患排查</option>
                                    <option name="playbook_type" value="5">密码/端口检测</option>
                                    <option name="playbook_type" value="6">安全访问控制</option>
                                </select>

                                <label class="control-label ">任务名称</label>
                                <input class="form-control auto-input input-sm" id="task_name" name="task_name" type="text" placeholder="任务名称">
                                <input type="button" id="query" class="btn btn-primary btn-sm" value="查询">
                                  <a class="btn btn-warning btn-sm" href="/apps/playbook/add"><i
                                class="fa fa-plus-circle "></i>&nbsp;新建任务</a>
                            </form>

                        </div>
                        <table id="deployTableList"
                               class="table table-striped table-bordered table-advance table-hove displayr nowrap"
                               style="word-break:break-all;width:100%">
                            <thead>
                            <tr>
                                <th class="text-center">任务名称</th>
                                <th class="text-center">任务类型</th>
                                <th class="text-center">描述</th>
                                <th class="text-center">更新时间</th>
                                <th class="text-center">操作</th>
                            </tr>
                            </thead>
                        </table>
                        <!-- /.table-responsive -->
{#                        <div class="well">#}
{#                            <h4>Ansible任务管理说明</h4>#}
{#                            <ol>#}
{#                                <li><p>Playbook文件host字段请配置成：hosts: "{ {host} }"</p></li>#}
{#                                <li><p>点击&nbsp;<i class="fa  fa-group"></i>&nbsp;查看目标服务器 </p></li>#}
{#                                <li><p>点击&nbsp;<i class="fa  fa-eye"></i>&nbsp;查看PlayBook信息</p></li>#}
{#                                <li><p>点击&nbsp;<i class="glyphicon glyphicon-edit"></i>&nbsp;编辑任务</p></li>#}
{#                                <li><p>点击&nbsp;<i class="fa fa-play-circle-o"></i>&nbsp;运行任务</p></li>#}
{#                                <li><p>点击&nbsp;<i class="glyphicon glyphicon-trash"></i>&nbsp;删除任务</p></li>#}
{#                            </ol>#}
{#                            <!--<a class="btn btn-default btn-lg btn-block" href="/apps/playbook/add"><i#}
{#                                    class="fa fa-plus-circle "></i>新建任务</a>-->#}
{#                        </div>#}
                    </div>
                    <!-- /.panel-body -->
                </div>
                <!-- /.panel -->
            </div>
        </div>
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
             aria-hidden="true">
            <div class="modal-dialog" style="width:1280px;height:auto;">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                            &times;
                        </button>
                        <h4 class="modal-title" id="myModalLabel">
                            Playbook文件内容
                        </h4>
                    </div>
                    <div class="modal-body">
				<pre id="pre" class="traditional">
					<div id="play_content">
					</div>
				</pre>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭
                        </button>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal -->
        </div>
    </div>
    <script>
         $(document).ready(function () {
             var autoinput = $("input.auto-input");
             autoinput.attr('size', 4);
             autoinput.keyup(function () {
                 $(this).attr('size', $(this).val().length > 4 ? $(this).val().length : 4);
             });
             autoinput.keydown(function () {
                 $(this).keyup()
             });
         });
    </script>
    <script src="../../static/js/config.js"></script>
    <script type="text/javascript">
        var oTable = null;
        /* $(document).ready(function () {
         $("[data-toggle='popover']").popover();
         initTable();
         });*/
        $(document).ready(function () {
            initTable();

            $("#query").click(function () {
                initTable();
            })
        });

        var initTable = function () {
            if (oTable != null) {
                oTable.fnClearTable(0);
                oTable.fnDraw(); //重新加载数据
                oTable.fnDestroy();
            }
            oTable = $('#deployTableList').dataTable({
                "fnPreDrawCallback": function () {
                    $('.dataTable_header').remove();
                },
                "aLengthMenu": [10, 20, 50, 100], //更改显示记录数选项
                "bProcessing": true,
                /*"scrollX": true,*/
                "bStateSave": true, //是否打开客户端状态记录功能,此功能在ajax刷新纪录的时候不会将个性化设定回复为初始化状态
                "bJQueryUI": false, //是否使用 jQury的UI theme
                "bFilter": false,// 搜索栏
                "bLengthChange": true, //关闭每页显示多少条数据
                "bSort": false,
                "bStateSave": false,
                "bServerSide": true,
                "iDisplayStart": 0,
                "iDisplayLength": 10,
                "bScrollCollapse": true, //是否开启DataTables的高度自适应，当数据条数不够分页数据条数的时候，插件高度是否随数据条数而改变
                "bAutoWidth": false, //是否自适应宽度
                "aoColumns": [//设定各列宽度
                    {
                        "mData": "playbook_name",
                        "sDefaultContent": "",
                        "bSearchable": false,
                        "sClass": "text-center"
                    },
                    {
                        "mData": "playbook_type",
                        "sDefaultContent": "",
                        "bSearchable": false,
                        "sClass": "text-center"
                    },
                    {
                        "mData": "playbook_desc",
                        "sDefaultContent": "",
                        "bSearchable": false,
                        "sClass": "text-center"
                    },
                    {"mData": "update_time", "sDefaultContent": "", "bSearchable": false, "sClass": "text-center"},
                    {"mData": null, "sDefaultContent": "", "bSearchable": false, "sClass": "text-center"},
                ],
                "abuttons":['copy', 'excel', 'pdf'],
                "oLanguage": {
                    "sLengthMenu": "每页显示 _MENU_条",
                    "sZeroRecords": "没有找到符合条件的数据",
                    "sProcessing": " 数据加载中， 请稍候......",
                    "sInfo": "当前第 _START_ - _END_ 条　共计 _TOTAL_ 条",
                    "sInfoEmpty": "没有记录",
                    "sInfoFiltered": "(从 _MAX_ 条记录中过滤)",
                    "sSearch": "",
                    "oPaginate": {
                        "sFirst": "首页",
                        "sPrevious": "前一页",
                        "sNext": "后一页",
                        "sLast": "尾页"
                    }
                },
                "fnRowCallback": function (nRow, aData, iDisplayIndex) {
                    var playbook_type = aData.playbook_type;
                    if (playbook_type == 1) {
                        playbook_type = "资产信息";
                    } else if (playbook_type == 2) {
                        playbook_type = "基线加固";
                    } else if (playbook_type == 3) {
                        playbook_type = "日志审计";
                    } else if (playbook_type == 4) {
                        playbook_type = "漏洞整改与隐患排查";
                    } else if (playbook_type == 5) {
                        playbook_type = "密码/端口检测";
                    } else if (playbook_type == 6) {
                        playbook_type = "安全访问控制";
                    }
                    $('td:eq(1)', nRow).html(playbook_type);//设置该列的值

                    var id = aData.id;
                    var playbook_number = aData.playbook_number;
                    var html = '<button type="button"  class="btn btn-primary btn-xs" data-toggle="modal" data-target="#myModal" onclick="getAnsibleServer(this,\'' + playbook_number + '\')"><abbr title="目标服务器"><i class="fa  fa-group  "></i></abbr></button>&nbsp;' +
                        '<button type="button"  class="btn btn-primary btn-xs" data-toggle="modal" data-target="#myModal" onclick="getAnsiblePlayBookFile(this,\'' + id + '\')"><abbr title="查看Playbook文件"><i class="fa  fa-eye  "></i></abbr></button>&nbsp;' +
                        '<a href="/apps/playbook/modf/' + id + '" target="_blank"><button  type="button" class="btn btn-info btn-xs"><abbr title="修改资料"><i class="glyphicon glyphicon-edit"></i></abbr ></button></a>&nbsp;' +
                        '<a href="/apps/playbook/run/' + id + '" target="_blank"><button  type="button" class="btn btn-warning btn-xs"><abbr title="运行Playbook"><i class="fa fa-play-circle-o"></i></abbr></button></a>&nbsp;' +
                        '<button  type="button" class="btn btn-danger btn-xs" onclick="deletePlayBook(this,\'' + id + '\')"><abbr title="删除"><i class="glyphicon glyphicon-trash"></i></abbr></button>&nbsp;';
                    $('td:eq(4)', nRow).html(html);//设置该列的值
                    return nRow;
                },
                "sAjaxSource": "/apps/",
                "fnServerData": retrieveModelData
            });
        }

        function retrieveModelData(sSource, aoData, fnCallback) {
            var iDisplayStart = 0;
            var iDisplayLength = 10;
            var sEcho;
            for (var i = 0; i < aoData.length; i++) {
                if (aoData[i].name == "iDisplayStart") {
                    iDisplayStart = aoData[i].value;
                } else if (aoData[i].name == "iDisplayLength") {
                    iDisplayLength = aoData[i].value;
                }
                else if (aoData[i].name == "sEcho") {
                    sEcho = aoData[i].value;
                }
            }
            var page = (iDisplayStart / iDisplayLength) + 1;
            $.ajax({
                "type": "post",
                "url": sSource,
                "dataType": "json",
                "data": {
                    "playbook_type": $("#playbook_type").val(),
                    "task_name" : $("#task_name").val(),
                    "aoData": aoData,
                    "iDisplayStart": iDisplayStart,
                    "iDisplayLength": iDisplayLength,
                    "page": page,
                    "sEcho": sEcho
                },
                "success": function (resp) {
                    fnCallback(resp);
                },
                "error": function (response) {
                    window.wxc.xcConfirm("数据格式不合法~", window.wxc.xcConfirm.typeEnum.error);
                }
            });
        }
        function deletePlayBook(obj, id) {
            var txt = "是否确认删除？";
            var btnObj = $(obj);
            btnObj.attr('disabled', true);
            var option = {
                title: "删除任务",
                btn: parseInt("0011", 2),
                onOk: function () {
                    $.ajax({
                        type: 'DELETE',
                        url: '/api/playbook/' + id + '/',
                        success: function (response) {
                            btnObj.removeAttr('disabled');
                            window.wxc.xcConfirm("删除成功！", window.wxc.xcConfirm.typeEnum.success);
                            location.reload('/apps/');
                        },
                        error: function (response) {
                            btnObj.removeAttr('disabled');
                            window.wxc.xcConfirm("删除失败！", window.wxc.xcConfirm.typeEnum.error);
                        }
                    });
                },
                onCancel: function () {
                    btnObj.attr('disabled', false);
                },
                onClose: function () {
                    btnObj.attr('disabled', false);
                }
            }
            window.wxc.xcConfirm(txt, "custom", option);
        }

        function getAnsibleServer(obj, server) {
            var server = server.replace(new RegExp(',', "gm"), '\n');
            $("#play_content").html(server);
            $("#myModalLabel").html("执行主机");
        }

        function getAnsiblePlayBookFile(obj, id) {
            var btnObj = $(obj);
            $.ajax({
                url: '/apps/playbook/file/' + id + '/', //请求地址
                type: "POST",  //提交类似
                data: {
                    "id": id
                },  //提交参数
                success: function (response) {
                    btnObj.removeAttr('disabled');
                    $("#myModalLabel").html("Playbook文件内容");
                    if (response["code"] == "200") {
                        btnObj.removeAttr('disabled');
                        $("#play_content").html(response["data"]);
                    } else {
                        $("#play_content").html('');
                    }

                },
                error: function (response) {
                    btnObj.removeAttr('disabled');
                    window.wxc.xcConfirm("查看失败", window.wxc.xcConfirm.typeEnum.error);
                }
            })
        }

        function deleteProject(obj, id) {
            var txt = "是否确认删除？";
            var btnObj = $(obj);
            btnObj.attr('disabled', true);
            var option = {
                title: "删除任务",
                btn: parseInt("0011", 2),
                onOk: function () {
                    $.ajax({
                        type: 'DELETE',
                        url: '/api/deploy/' + id + '/',
                        success: function (response) {
                            btnObj.removeAttr('disabled');
                            window.wxc.xcConfirm("删除成功！", window.wxc.xcConfirm.typeEnum.success);
                            location.reload('/deploy_list/');
                        },
                        error: function (response) {
                            btnObj.removeAttr('disabled');
                            window.wxc.xcConfirm("删除失败！", window.wxc.xcConfirm.typeEnum.error);
                        }
                    });
                },
                onCancel: function () {
                },
                onClose: function () {
                }
            }
            window.wxc.xcConfirm(txt, "custom", option);
        }

        function initProject(obj, name, id) {
            var txt = "是否确认初始化（" + name + "）";
            var btnObj = $(obj);
            btnObj.attr('disabled', true);
            var option = {
                title: "初始化项目",
                btn: parseInt("0011", 2),
                onOk: function () {
                    $.ajax({
                        type: 'POST',
                        url: '/deploy_init/' + id + '/',
                        success: function (response) {
                            if (response['code'] == 200) {
                                btnObj.removeAttr('disabled');
                                window.wxc.xcConfirm("初始化成功！", window.wxc.xcConfirm.typeEnum.success);
                                location.reload('/deploy_list/');
                            }
                            else {
                                btnObj.removeAttr('disabled');
                                window.wxc.xcConfirm("初始化失败，失败原因：" + response['msg'], window.wxc.xcConfirm.typeEnum.error);
                            }

                        },
                        error: function (response) {
                            btnObj.removeAttr('disabled');
                            window.wxc.xcConfirm("初始化失败", window.wxc.xcConfirm.typeEnum.error);
                        }
                    });
                },
                onCancel: function () {
                },
                onClose: function () {
                }
            }
            window.wxc.xcConfirm(txt, "custom", option);
        }


        function projcectVersion(obj, model, id, op) {
            var btnObj = $(obj);
            btnObj.attr('disabled', true);
            if (op == 'create') {
                txt = "请输入要创建的分支：";
            }
            else {
                txt = "请输入要删除的分支：";
            }
            ;
            window.wxc.xcConfirm(txt, window.wxc.xcConfirm.typeEnum.input, {
                onOk: function (result) {
                    if (result.length == 0) {
                        /* 如果没有输入字符串则直接退出 */
                        return;
                    }
                    ;
                    $.ajax({
                        type: 'POST',
                        url: '/deploy_version/' + id + '/',
                        data: {
                            "model": model,
                            'name': result,
                            'op': op,
                        },
                        success: function (response) {

                            if (response["code"] == "200") {
                                window.wxc.xcConfirm(response["msg"], window.wxc.xcConfirm.typeEnum.success);
                            }
                            else {
                                window.wxc.xcConfirm("分支操作错误：" + response["msg"], window.wxc.xcConfirm.typeEnum.error);
                            }
                            ;
                            btnObj.removeAttr('disabled');
                        },
                        error: function (response) {
                            btnObj.removeAttr('disabled');
                            window.wxc.xcConfirm("创建分支失败", window.wxc.xcConfirm.typeEnum.error);
                        },
                    });

                }
            });
        }
    </script>

{% endblock %}